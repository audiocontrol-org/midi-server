name: Installer Package Probe

on:
  workflow_dispatch:
    inputs:
      use_timestamp:
        description: "Enable productsign --timestamp"
        required: false
        default: false
        type: boolean
      productsign_timeout_seconds:
        description: "Timeout for productsign"
        required: false
        default: "180"
        type: string
      sign_target:
        description: "Artifact to sign (distribution|component)"
        required: false
        default: "distribution"
        type: string

permissions:
  contents: read

jobs:
  probe-installer-packaging:
    runs-on: macos-latest
    timeout-minutes: 12
    env:
      KEYCHAIN_NAME: build.keychain-db
      KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Import Developer ID certificates
        shell: bash
        run: |
          set -euo pipefail
          APP_P12="$RUNNER_TEMP/app-cert.p12"
          INSTALLER_P12="$RUNNER_TEMP/installer-cert.p12"

          decode_base64() {
            local output="$1"
            if echo "$2" | base64 --decode > "$output" 2>/dev/null; then
              return 0
            fi
            echo "$2" | base64 -D > "$output"
          }

          decode_base64 "$APP_P12" "$MACOS_APP_CERT_P12_BASE64"
          decode_base64 "$INSTALLER_P12" "$MACOS_INSTALLER_CERT_P12_BASE64"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 3600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" login.keychain-db
          security default-keychain -s "$KEYCHAIN_NAME"

          security import "$APP_P12" \
            -k "$KEYCHAIN_NAME" \
            -P "$MACOS_APP_CERT_P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security import "$INSTALLER_P12" \
            -k "$KEYCHAIN_NAME" \
            -P "$MACOS_INSTALLER_CERT_P12_PASSWORD" \
            -T /usr/bin/productsign \
            -T /usr/bin/pkgbuild \
            -T /usr/bin/security

          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_NAME"
        env:
          MACOS_APP_CERT_P12_BASE64: ${{ secrets.MACOS_APP_CERT_P12_BASE64 }}
          MACOS_APP_CERT_P12_PASSWORD: ${{ secrets.MACOS_APP_CERT_P12_PASSWORD }}
          MACOS_INSTALLER_CERT_P12_BASE64: ${{ secrets.MACOS_INSTALLER_CERT_P12_BASE64 }}
          MACOS_INSTALLER_CERT_P12_PASSWORD: ${{ secrets.MACOS_INSTALLER_CERT_P12_PASSWORD }}

      - name: Run package probe
        timeout-minutes: 8
        run: ./packaging/macos/installer-package-probe.sh
        env:
          DEVELOPER_ID_APP: ${{ secrets.DEVELOPER_ID_APP }}
          DEVELOPER_ID_INSTALLER: ${{ secrets.DEVELOPER_ID_INSTALLER }}
          PRODUCTSIGN_TIMEOUT_SECONDS: ${{ inputs.productsign_timeout_seconds || '180' }}
          PRODUCTSIGN_USE_TIMESTAMP: ${{ inputs.use_timestamp && 'true' || 'false' }}
          PROBE_SIGN_TARGET: ${{ inputs.sign_target || 'distribution' }}
