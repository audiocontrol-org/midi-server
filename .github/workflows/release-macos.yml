name: Release macOS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos-release:
    runs-on: macos-latest
    env:
      KEYCHAIN_NAME: build.keychain-db
      KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: dashboard/package-lock.json

      - name: Resolve version from tag
        id: version
        shell: bash
        run: |
          if [[ "${GITHUB_REF_NAME}" == v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            VERSION="$(tr -d '[:space:]' < VERSION)"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Release version: $VERSION"

      - name: Import Developer ID certificates
        shell: bash
        run: |
          set -euo pipefail
          APP_P12="$RUNNER_TEMP/app-cert.p12"
          INSTALLER_P12="$RUNNER_TEMP/installer-cert.p12"

          decode_base64() {
            local output="$1"
            if echo "$2" | base64 --decode > "$output" 2>/dev/null; then
              return 0
            fi
            echo "$2" | base64 -D > "$output"
          }

          decode_base64 "$APP_P12" "$MACOS_APP_CERT_P12_BASE64"
          decode_base64 "$INSTALLER_P12" "$MACOS_INSTALLER_CERT_P12_BASE64"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" login.keychain-db
          security default-keychain -s "$KEYCHAIN_NAME"

          security import "$APP_P12" \
            -k "$KEYCHAIN_NAME" \
            -P "$MACOS_APP_CERT_P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security import "$INSTALLER_P12" \
            -k "$KEYCHAIN_NAME" \
            -P "$MACOS_INSTALLER_CERT_P12_PASSWORD" \
            -T /usr/bin/productsign \
            -T /usr/bin/pkgbuild \
            -T /usr/bin/security

          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_NAME"

          security find-identity -v
        env:
          MACOS_APP_CERT_P12_BASE64: ${{ secrets.MACOS_APP_CERT_P12_BASE64 }}
          MACOS_APP_CERT_P12_PASSWORD: ${{ secrets.MACOS_APP_CERT_P12_PASSWORD }}
          MACOS_INSTALLER_CERT_P12_BASE64: ${{ secrets.MACOS_INSTALLER_CERT_P12_BASE64 }}
          MACOS_INSTALLER_CERT_P12_PASSWORD: ${{ secrets.MACOS_INSTALLER_CERT_P12_PASSWORD }}

      - name: Build signed and notarized release artifacts
        run: ./packaging/macos/release-build.sh --version "${{ steps.version.outputs.version }}"
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          DEVELOPER_ID_APP: ${{ secrets.DEVELOPER_ID_APP }}
          DEVELOPER_ID_INSTALLER: ${{ secrets.DEVELOPER_ID_INSTALLER }}
          CSC_NAME: ${{ secrets.CSC_NAME }}
          CSC_IDENTITY_AUTO_DISCOVERY: "false"

      - name: Verify release artifacts
        run: |
          ls -la dashboard/dist
          test -n "$(find dashboard/dist -name 'latest-mac*.yml' -type f | head -1)"
          test -n "$(find dashboard/dist -name '*-${{ steps.version.outputs.version }}*-mac.zip' -type f | head -1)"
          test -n "$(find dashboard/dist -name '*-${{ steps.version.outputs.version }}*.dmg' -type f | head -1)"
          test -f "build/pkg/MidiServer-${{ steps.version.outputs.version }}.pkg"

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MidiServer-macOS-release
          path: |
            dashboard/dist/*.dmg
            dashboard/dist/*.zip
            dashboard/dist/*.blockmap
            dashboard/dist/latest-mac*.yml
            build/pkg/MidiServer-*.pkg

      - name: Publish GitHub release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dashboard/dist/*.dmg
            dashboard/dist/*.zip
            dashboard/dist/*.blockmap
            dashboard/dist/latest-mac*.yml
            build/pkg/MidiServer-*.pkg
