name: Installer Sign Smoke

on:
  workflow_dispatch:
    inputs:
      use_timestamp:
        description: "Enable productsign --timestamp"
        required: false
        default: false
        type: boolean
      productsign_timeout_seconds:
        description: "Timeout for productsign"
        required: false
        default: "180"
        type: string
  push:
    branches:
      - main
    paths:
      - '.github/workflows/installer-sign-smoke.yml'
      - 'packaging/macos/installer-sign-smoke.sh'

permissions:
  contents: read

jobs:
  smoke-sign-installer:
    runs-on: macos-latest
    timeout-minutes: 10
    env:
      KEYCHAIN_NAME: build.keychain-db
      KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Import Installer certificate
        shell: bash
        run: |
          set -euo pipefail
          INSTALLER_P12="$RUNNER_TEMP/installer-cert.p12"

          decode_base64() {
            local output="$1"
            if echo "$2" | base64 --decode > "$output" 2>/dev/null; then
              return 0
            fi
            echo "$2" | base64 -D > "$output"
          }

          decode_base64 "$INSTALLER_P12" "$MACOS_INSTALLER_CERT_P12_BASE64"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 3600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" login.keychain-db
          security default-keychain -s "$KEYCHAIN_NAME"

          security import "$INSTALLER_P12" \
            -k "$KEYCHAIN_NAME" \
            -P "$MACOS_INSTALLER_CERT_P12_PASSWORD" \
            -T /usr/bin/productsign \
            -T /usr/bin/pkgbuild \
            -T /usr/bin/security

          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_NAME"

          security find-identity -v -p basic
        env:
          MACOS_INSTALLER_CERT_P12_BASE64: ${{ secrets.MACOS_INSTALLER_CERT_P12_BASE64 }}
          MACOS_INSTALLER_CERT_P12_PASSWORD: ${{ secrets.MACOS_INSTALLER_CERT_P12_PASSWORD }}

      - name: Sign dummy installer
        timeout-minutes: 5
        run: ./packaging/macos/installer-sign-smoke.sh
        env:
          DEVELOPER_ID_INSTALLER: ${{ secrets.DEVELOPER_ID_INSTALLER }}
          PRODUCTSIGN_TIMEOUT_SECONDS: ${{ inputs.productsign_timeout_seconds || '180' }}
          PRODUCTSIGN_USE_TIMESTAMP: ${{ inputs.use_timestamp && 'true' || 'false' }}
