#!/bin/bash
# Post-install script for MIDI HTTP Server
# Runs after package installation

# =============================================================================
# Logging and Error Handling Setup
# =============================================================================
LOG_FILE="/tmp/MidiServer-install.log"
SCRIPT_NAME="postinstall"
GITHUB_REPO="audiocontrol-org/midi-server"

log() {
    local timestamp
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [$SCRIPT_NAME] $1" | tee -a "$LOG_FILE"
}

log_error() {
    log "ERROR: $1"
}

# Get actual hardware architecture (not affected by Rosetta)
get_hardware_arch() {
    # Check if running on Apple Silicon hardware
    if /usr/sbin/sysctl -n hw.optional.arm64 2>/dev/null | grep -q "1"; then
        echo "arm64 (Apple Silicon)"
    else
        echo "x86_64 (Intel)"
    fi
}

# Get process architecture (may differ from hardware under Rosetta)
get_process_arch() {
    uname -m
}

url_encode() {
    python3 -c "import urllib.parse; print(urllib.parse.quote('''$1''', safe=''))"
}

copy_log_to_clipboard() {
    if [ -f "$LOG_FILE" ]; then
        cat "$LOG_FILE" | pbcopy
        return 0
    fi
    return 1
}

generate_github_issue_url() {
    local error_message="$1"

    # Gather system info
    local macos_version=$(sw_vers -productVersion)
    local macos_build=$(sw_vers -buildVersion)
    local hw_arch=$(get_hardware_arch)
    local proc_arch=$(get_process_arch)

    # Build issue body (without log contents - user will paste from clipboard)
    local body="## Installation Error

**Error Message:**
\`\`\`
${error_message}
\`\`\`

## System Information

| Property | Value |
|----------|-------|
| macOS Version | ${macos_version} (${macos_build}) |
| Hardware | ${hw_arch} |
| Process | ${proc_arch} |
| Script | ${SCRIPT_NAME} |

## Installation Log

> **The log file contents have been copied to your clipboard.**
> Please paste them below (Cmd+V):

\`\`\`
PASTE LOG CONTENTS HERE
\`\`\`

## Additional Context

<!-- Please add any additional context about what you were doing when this error occurred -->
"

    local title="Installation failed: ${SCRIPT_NAME} error"
    local encoded_title=$(url_encode "$title")
    local encoded_body=$(url_encode "$body")

    echo "https://github.com/${GITHUB_REPO}/issues/new?title=${encoded_title}&body=${encoded_body}&labels=bug,installer"
}

show_error_dialog() {
    local message="$1"
    local github_url=$(generate_github_issue_url "$message")

    osascript <<EOF
set keepOpen to true
repeat while keepOpen
    set buttonPressed to button returned of (display dialog "MidiServer Installation Failed

$message

Log file location:
$LOG_FILE" buttons {"Report Issue", "Open Log Folder", "OK"} default button "OK" with icon stop with title "Installation Error")

    if buttonPressed is "Open Log Folder" then
        do shell script "open -R '$LOG_FILE'"
    else if buttonPressed is "Report Issue" then
        do shell script "cat '$LOG_FILE' | pbcopy"
        do shell script "open '$github_url'"
        display dialog "The installation log has been copied to your clipboard.

When the GitHub issue page opens, paste (Cmd+V) the log contents into the issue where indicated." buttons {"OK"} default button "OK" with icon note with title "Log Copied"
    else
        set keepOpen to false
    end if
end repeat
EOF
}

handle_error() {
    local exit_code=$?
    local line_number=$1
    log_error "Script failed at line $line_number with exit code $exit_code"
    log "--- Stack trace ---"
    local frame=0
    while caller $frame; do
        ((frame++))
    done 2>/dev/null >> "$LOG_FILE"
    log "--- Installation failed ---"
    show_error_dialog "Postinstall script failed at line $line_number.

Exit code: $exit_code

Check the log file for details."
    exit $exit_code
}

# Trap errors - this works with set -e
trap 'handle_error $LINENO' ERR
set -e

# =============================================================================
# Continue Log from Preinstall
# =============================================================================
log ""
log "=== MidiServer Postinstall Script Started ==="

# System information (brief, since preinstall logged details)
log "--- Environment Check ---"
log "User: $(whoami)"
log "Effective UID: $EUID"
log "Working Directory: $(pwd)"

# Installer environment
log "--- Installer Environment ---"
log "INSTALLER_TEMP: ${INSTALLER_TEMP:-not set}"
log "PACKAGE_PATH: ${PACKAGE_PATH:-not set}"
log "DSTROOT: ${DSTROOT:-not set}"
log "DSTVOLUME: ${DSTVOLUME:-not set}"

# =============================================================================
# Main Script
# =============================================================================
APP_PATH="/Applications/AudioControl/MidiServer.app"
BINARY_PATH="$APP_PATH/Contents/Resources/bin/midi-http-server"

log "--- Configuration ---"
log "APP_PATH: $APP_PATH"
log "BINARY_PATH: $BINARY_PATH"

# Verify app was installed
log "--- Verifying installation ---"
if [ ! -d "$APP_PATH" ]; then
    log_error "App not found at $APP_PATH"
    log "--- Diagnostic information ---"
    log "Contents of /Applications/AudioControl:"
    ls -la /Applications/AudioControl 2>&1 | while read line; do log "  $line"; done || log "  (directory not found)"

    show_error_dialog "App not found at expected location:
$APP_PATH

The installation may be incomplete."
    exit 1
fi
log "Found app at $APP_PATH"

# Log build info for diagnostics
BUILD_INFO_FILE="$APP_PATH/Contents/Resources/build-info.txt"
if [ -f "$BUILD_INFO_FILE" ]; then
    log "--- Build Information ---"
    while IFS= read -r line; do log "$line"; done < "$BUILD_INFO_FILE"
else
    log "WARNING: No build-info.txt found (pre-0.2.0 build or build info missing)"
fi

# Verify bundled binary exists
log "Checking for bundled binary at: $BINARY_PATH"
if [ -f "$BINARY_PATH" ]; then
    log "Found midi-http-server at $BINARY_PATH"
    log "File details: $(ls -la "$BINARY_PATH")"

    # Make executable (should already be, but ensure)
    log "Ensuring executable permissions..."
    chmod +x "$BINARY_PATH"
    log "midi-http-server installed successfully"
else
    log_error "Bundled binary not found at $BINARY_PATH"
    log "--- Diagnostic information ---"
    log "Contents of app Resources:"
    ls -la "$APP_PATH/Contents/Resources" 2>&1 | while read line; do log "  $line"; done || log "  (failed to list)"
    log "Contents of app Resources/bin:"
    ls -la "$APP_PATH/Contents/Resources/bin" 2>&1 | while read line; do log "  $line"; done || log "  (directory not found)"

    show_error_dialog "Bundled binary not found at expected location:
$BINARY_PATH

The app bundle may be corrupted."
    exit 1
fi

log "=== Postinstall completed successfully ==="
exit 0
